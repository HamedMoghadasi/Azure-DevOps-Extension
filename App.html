<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>LeadTime and CycleTime</title>
  </head>

  <body style="overflow:auto;">
    <script src="lib/VSS.SDK.min.js"></script>
    <script src="dist/jquery.min.js"></script>

    <script>
      VSS.init({
        explicitNotifyLoaded: true,
        usePlatformScripts: true
      });

      var webHook = {
        get: function() {
          $.ajax({
            //Fake Address
            url: "https://localhost:5001/api/workitem",
            type: "GET",
            dataType: "json",
            success: function(result) {
              console.log("ajaxData", result);
              diagramModule.data = result;
              console.log("end pushing data in ajax");
            }
          });
        },

        init: function() {}
      };
      var diagramModule = {
        data: {},

        DateDifferenceInDay: function(firstDate, SecondDate) {
          dt1 = new Date(firstDate);
          dt2 = new Date(SecondDate);
          return Math.floor(
            (Date.UTC(dt2.getFullYear(), dt2.getMonth(), dt2.getDate()) -
              Date.UTC(dt1.getFullYear(), dt1.getMonth(), dt1.getDate())) /
              (1000 * 60 * 60 * 24)
          );
        },

        calculateLeadTime: function(data) {
          webHook.get();
          let a = diagramModule.data;
          console.log("get data -------> ", a);
          let createdOn = data["System.CreatedDate"];
          $("#LeadTime").data("CreatedDate", createdOn);
          let closedOn = data["Microsoft.VSTS.Common.ClosedDate"];
          if (closedOn === null) {
            closedOn = new Date();
          }

          let days = diagramModule.DateDifferenceInDay(
            createdOn,
            closedOn.toLocaleDateString()
          );

          return {
            createdOn: createdOn,
            closedOn: closedOn,
            days: days
          };
        },

        prepareLeadTimeContent: function(createdOn, closedOn, days) {
          return `This work item <i><b>Created in ${createdOn} </b></i> and its go on till  <i><b> ${closedOn} </b></i> and its LeadTime days is<i><b> ${days} Days </b></i>`;
        },
        init: function() {}
      };

      VSS.require(["TFS/WorkItemTracking/Services"], function(
        _WorkItemServices
      ) {
        function getWorkItemFormService() {
          return _WorkItemServices.WorkItemFormService.getService();
        }

        diagramModule.init();
        webHook.init();

        VSS.register(VSS.getContribution().id, function() {
          return {
            onLoaded: function(args) {
              getWorkItemFormService().then(function(service) {
                service
                  .getFieldValues([
                    "System.Id",
                    "System.CreatedDate",
                    "Microsoft.VSTS.Common.ClosedDate"
                  ])
                  .then(function(data) {
                    console.log("serviceeee ---->", service);
                    let leadTime = diagramModule.calculateLeadTime(data);

                    let result = diagramModule.prepareLeadTimeContent(
                      leadTime.createdOn.toLocaleDateString(),
                      leadTime.closedOn.toLocaleDateString(),
                      leadTime.days
                    );

                    $("#diagram").html(result);
                  });
              });
            }
          };
        });

        VSS.notifyLoadSucceeded();
      });
    </script>

    <div id="diagram">
      <span id="LeadTime" data-CreatedDate="" hidden></span>
    </div>
  </body>
</html>
